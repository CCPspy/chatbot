<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus AI: Ultimate Station</title>
    
    <!-- UI Framework -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Markdown & Code Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    
    <!-- Math Rendering (KaTeX) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(51, 65, 85, 0.5); }
        
        /* Animations */
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .msg-enter { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .typing-dot { animation: pulse 1.4s infinite; display: inline-block; width: 4px; height: 4px; border-radius: 50%; background: currentColor; margin: 0 1px; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.5); opacity: 1; } }

        /* Markdown Styles */
        .prose pre { margin: 0.5em 0; border-radius: 0.5rem; background: #1e293b !important; }
        .prose code { color: #e2e8f0; background: #1e293b; padding: 2px 4px; rounded: 4px; font-size: 0.9em; }
        .prose pre code { background: transparent; padding: 0; color: inherit; }
        .katex-display { margin: 1em 0; overflow-x: auto; overflow-y: hidden; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 h-screen flex overflow-hidden font-sans selection:bg-blue-500/30">

    <!-- SIDEBAR -->
    <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex z-30 shadow-2xl">
        <div class="p-5 border-b border-slate-800 bg-slate-900/50">
            <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent flex items-center gap-2">
                <i data-lucide="cpu" class="text-cyan-400"></i> Nexus AI
            </h1>
            <div class="flex items-center gap-2 mt-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-[10px] text-slate-400 font-mono">GPU ACTIVE</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <!-- Model Selector -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Neural Engine</label>
                <select id="model-select" onchange="handleModelChange()" class="w-full bg-slate-800 text-sm border border-slate-700 rounded-lg p-3 outline-none focus:border-cyan-500 transition-all cursor-pointer text-slate-200 shadow-sm">
                    <!-- Populated by JS -->
                </select>
                <div id="model-badge" class="text-[10px] bg-slate-800 border border-slate-700 p-2 rounded text-slate-400 flex gap-2 items-start">
                    <i data-lucide="info" class="w-3 h-3 mt-0.5 shrink-0"></i>
                    <span id="model-desc">Select a model to begin.</span>
                </div>
            </div>

            <!-- Toggles -->
            <div class="space-y-3">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Augmentations</label>
                
                <div class="group flex items-center justify-between p-3 bg-slate-800/40 rounded-lg border border-transparent hover:border-slate-700 transition-all cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-green-500/10 rounded-md text-green-400"><i data-lucide="globe" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-sm font-medium text-slate-200">Live Web Search</div>
                            <div class="text-[10px] text-slate-500">Access real-time data</div>
                        </div>
                    </div>
                    <input type="checkbox" id="web-toggle" class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-cyan-600 focus:ring-offset-slate-900">
                </div>

                <div class="group flex items-center justify-between p-3 bg-slate-800/40 rounded-lg border border-transparent hover:border-slate-700 transition-all cursor-pointer">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-purple-500/10 rounded-md text-purple-400"><i data-lucide="brain-circuit" class="w-4 h-4"></i></div>
                        <div>
                            <div class="text-sm font-medium text-slate-200">Deep Reasoning</div>
                            <div class="text-[10px] text-slate-500">Chain-of-thought logic</div>
                        </div>
                    </div>
                    <input type="checkbox" id="think-toggle" class="w-4 h-4 rounded bg-slate-700 border-slate-600 text-purple-600 focus:ring-offset-slate-900">
                </div>
            </div>

            <!-- Download Status -->
            <div id="init-panel" class="hidden animate-fade-in">
                <div class="h-px bg-slate-800 my-4"></div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 shadow-lg">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-bold text-cyan-400 animate-pulse">Downloading Model...</span>
                        <span id="progress-text" class="text-xs font-mono text-slate-300">0%</span>
                    </div>
                    <div class="w-full bg-slate-900 rounded-full h-1.5 overflow-hidden">
                        <div id="progress-bar" class="bg-gradient-to-r from-cyan-500 to-blue-600 h-full w-0 transition-all duration-300 ease-out"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-[10px] text-slate-500 font-mono">
                        <span id="dl-timer">00:00</span>
                        <span>Keep tab open</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 bg-slate-900 border-t border-slate-800">
            <button id="load-btn" onclick="initEngine()" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-3 px-4 rounded-xl transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 group">
                <i data-lucide="power" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> Load System
            </button>
        </div>
    </aside>

    <!-- MAIN CHAT AREA -->
    <main class="flex-1 flex flex-col relative bg-slate-950">
        
        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-20 sticky top-0">
            <div class="flex items-center gap-2">
                <i data-lucide="cpu" class="text-cyan-400 w-5 h-5"></i>
                <span class="font-bold text-slate-200">Nexus AI</span>
            </div>
            <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="p-2 text-slate-400 hover:text-white"><i data-lucide="menu"></i></button>
        </header>

        <!-- Messages -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-40 scroll-smooth relative">
            <div id="welcome-screen" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 opacity-100 transition-opacity duration-500 pointer-events-none">
                <div class="w-24 h-24 bg-slate-900 rounded-3xl flex items-center justify-center mb-6 border border-slate-800 shadow-2xl">
                    <i data-lucide="command" class="w-10 h-10 text-cyan-500"></i>
                </div>
                <h2 class="text-3xl font-bold text-slate-100 mb-3 tracking-tight">System Ready</h2>
                <p class="text-slate-500 max-w-sm leading-relaxed">Select a neural engine from the sidebar to initialize the local GPU interface.</p>
                <div class="mt-8 flex gap-3">
                    <span class="text-[10px] bg-slate-900 border border-slate-800 px-3 py-1 rounded-full text-slate-400">Offline Capable</span>
                    <span class="text-[10px] bg-slate-900 border border-slate-800 px-3 py-1 rounded-full text-slate-400">Private</span>
                    <span class="text-[10px] bg-slate-900 border border-slate-800 px-3 py-1 rounded-full text-slate-400">Uncensored</span>
                </div>
            </div>
        </div>

        <!-- Smart Suggestion Toast (Hidden by default) -->
        <div id="suggestion-toast" class="absolute bottom-28 left-1/2 transform -translate-x-1/2 bg-slate-800 border border-slate-700 shadow-2xl rounded-lg p-3 hidden items-center gap-3 z-30 min-w-[300px] animate-bounce-in">
            <div class="bg-yellow-500/20 p-2 rounded text-yellow-500"><i data-lucide="lightbulb" class="w-4 h-4"></i></div>
            <div class="flex-1">
                <p class="text-xs font-bold text-slate-200">Smart Recommendation</p>
                <p class="text-[10px] text-slate-400" id="suggestion-text">Switch to Qwen Coder for better code?</p>
            </div>
            <button onclick="applySuggestion()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-xs rounded font-medium transition-colors">Switch</button>
            <button onclick="closeSuggestion()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-3 h-3"></i></button>
        </div>

        <!-- Stats Overlay -->
        <div id="gen-stats" class="hidden absolute top-4 right-4 bg-slate-900/80 backdrop-blur border border-slate-700 rounded-full px-4 py-1.5 flex items-center gap-3 shadow-xl z-20">
            <div class="flex items-center gap-1.5">
                <i data-lucide="clock" class="w-3 h-3 text-cyan-400"></i>
                <span id="timer-display" class="text-xs font-mono text-cyan-400">0.0s</span>
            </div>
            <div class="h-3 w-px bg-slate-700"></div>
            <span class="text-[10px] text-slate-500 font-mono tracking-wider">GENERATING</span>
        </div>

        <!-- Input Area -->
        <div class="absolute bottom-0 left-0 right-0 p-4 md:p-6 bg-gradient-to-t from-slate-950 via-slate-950/95 to-transparent z-40">
            <div class="max-w-4xl mx-auto glass rounded-2xl p-2 pl-4 flex items-end gap-3 shadow-2xl ring-1 ring-white/5 relative">
                
                <textarea id="user-input" rows="1" 
                    class="flex-1 bg-transparent border-none outline-none text-slate-200 placeholder-slate-600 resize-none py-3.5 max-h-48 text-sm md:text-base" 
                    placeholder="Type a message, or 'Imagine...' to generate art..."
                    oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'"></textarea>

                <div class="flex flex-col gap-2 pb-1">
                    <button id="send-btn" onclick="handleSend()" disabled class="p-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-900/20 active:scale-95">
                        <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="text-center mt-3 text-[10px] text-slate-600 font-mono">
                Running locally via WebLLM ‚Ä¢ Math rendered via KaTeX ‚Ä¢ Prism.js Syntax Highlighting
            </div>
        </div>

    </main>

    <!-- LOGIC -->
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm@0.2.46";

        // --- 1. ROBUST CONFIGURATION ---
        const models = [
            {
                id: "DeepSeek-R1-Distill-Llama-8B-q4f32_1-MLC",
                name: "DeepSeek R1 (8B)",
                type: "logic",
                desc: "üèÜ Best for Math & Logic. Supports <think> process.",
                heavy: true
            },
            {
                id: "Qwen2.5-Coder-7B-Instruct-q4f16_1-MLC",
                name: "Qwen 2.5 Coder (7B)",
                type: "code",
                desc: "üíª Best for Programming (Python, JS, C++).",
                heavy: true
            },
            {
                id: "Qwen2.5-1.5B-Instruct-q4f16_1-MLC",
                name: "Qwen 2.5 Turbo (1.5B)",
                type: "fast",
                desc: "üöÄ Ultra-fast. Works on phones and old laptops.",
                heavy: false
            },
            {
                id: "Llama-3.2-3B-Instruct-q4f16_1-MLC",
                name: "Llama 3.2 (3B)",
                type: "chat",
                desc: "‚öñÔ∏è Balanced chat assistant.",
                heavy: false
            }
        ];

        // Hardcoded libraries to ensure 100% uptime (No "Config Not Found" errors)
        const appConfig = {
            model_list: [
                {
                    "model": "https://huggingface.co/mlc-ai/DeepSeek-R1-Distill-Llama-8B-q4f32_1-MLC",
                    "model_id": "DeepSeek-R1-Distill-Llama-8B-q4f32_1-MLC",
                    "model_lib": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-models/v0.2.46/Llama-3.1-8B-Instruct-q4f32_1-ctx4k_cs1k-webgpu.wasm",
                },
                {
                    "model": "https://huggingface.co/mlc-ai/Qwen2.5-Coder-7B-Instruct-q4f16_1-MLC",
                    "model_id": "Qwen2.5-Coder-7B-Instruct-q4f16_1-MLC",
                    "model_lib": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-models/v0.2.46/Qwen2-7B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm",
                },
                {
                    "model": "https://huggingface.co/mlc-ai/Qwen2.5-1.5B-Instruct-q4f16_1-MLC",
                    "model_id": "Qwen2.5-1.5B-Instruct-q4f16_1-MLC",
                    "model_lib": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-models/v0.2.46/Qwen2-1.5B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm",
                },
                {
                     "model": "https://huggingface.co/mlc-ai/Llama-3.2-3B-Instruct-q4f16_1-MLC",
                     "model_id": "Llama-3.2-3B-Instruct-q4f16_1-MLC",
                     "model_lib": "https://raw.githubusercontent.com/mlc-ai/binary-mlc-llm-libs/main/web-llm-models/v0.2.46/Llama-3.2-3B-Instruct-q4f16_1-ctx4k_cs1k-webgpu.wasm"
                }
            ]
        };

        let engine = null;
        let genInterval = null;
        let dlInterval = null;
        let suggestedModelId = null;

        // --- 2. DEVICE CHECK & INIT ---
        window.onload = () => {
            const select = document.getElementById('model-select');
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            models.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id;
                let text = m.name;
                if(isMobile && m.heavy) {
                    text += " (‚ö†Ô∏è Heavy/PC Only)";
                    // We don't disable, but we warn
                }
                opt.text = text;
                select.appendChild(opt);
            });
            
            // Set default: DeepSeek for PC, Qwen 1.5B for Mobile
            select.value = isMobile ? models[2].id : models[0].id;
            handleModelChange(); // Update desc
            lucide.createIcons();
        };

        window.handleModelChange = () => {
            const val = document.getElementById('model-select').value;
            const model = models.find(m => m.id === val);
            document.getElementById('model-desc').innerText = model.desc;
        };

        // --- 3. SMART SUGGESTION LOGIC ---
        function checkIntent(text) {
            const current = document.getElementById('model-select').value;
            const codeKeywords = /html|javascript|python|css|function|script|code|loop|variable|array|react/i;
            const mathKeywords = /solve|calculate|equation|integral|derivative|algebra|math|theorem/i;

            // Suggest Coder
            if (codeKeywords.test(text) && !current.includes('Coder')) {
                showSuggestion("Detailed Coding", models[1].id);
                return true;
            }
            // Suggest Logic (DeepSeek)
            if (mathKeywords.test(text) && !current.includes('DeepSeek')) {
                showSuggestion("Math & Logic", models[0].id);
                return true;
            }
            return false;
        }

        function showSuggestion(reason, modelId) {
            suggestedModelId = modelId;
            const name = models.find(m => m.id === modelId).name;
            document.getElementById('suggestion-text').innerText = `Your prompt involves ${reason}. Switch to ${name}?`;
            document.getElementById('suggestion-toast').classList.replace('hidden', 'flex');
        }

        window.closeSuggestion = () => document.getElementById('suggestion-toast').classList.replace('flex', 'hidden');

        window.applySuggestion = async () => {
            closeSuggestion();
            document.getElementById('model-select').value = suggestedModelId;
            handleModelChange();
            await initEngine(); // Reload with new model
        };

        // --- 4. CORE ENGINE LOADER ---
        window.initEngine = async function() {
            const modelId = document.getElementById('model-select').value;
            const btn = document.getElementById('load-btn');
            
            // UI Reset
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader" class="animate-spin"></i> Initializing GPU...`;
            document.getElementById('init-panel').classList.remove('hidden');
            lucide.createIcons();

            // Download Timer
            let sec = 0;
            clearInterval(dlInterval);
            dlInterval = setInterval(() => {
                sec++;
                const m = Math.floor(sec/60).toString().padStart(2,'0');
                const s = (sec%60).toString().padStart(2,'0');
                document.getElementById('dl-timer').innerText = `${m}:${s}`;
            }, 1000);

            try {
                if(!engine) engine = new webllm.MLCEngine();
                engine.setAppConfig(appConfig); // Apply safe config

                engine.setInitProgressCallback((report) => {
                    const pct = Math.round(report.progress * 100);
                    document.getElementById('progress-text').innerText = `${pct}%`;
                    document.getElementById('progress-bar').style.width = `${pct}%`;
                    if(report.text.includes("Finish")) document.getElementById('progress-text').innerText = "Verifying Integrity...";
                });

                await engine.reload(modelId);

                // Success
                clearInterval(dlInterval);
                document.getElementById('init-panel').classList.add('hidden');
                document.getElementById('welcome-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('welcome-screen').remove(), 500);
                
                btn.className = "w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 cursor-default";
                btn.innerHTML = `<i data-lucide="check-circle"></i> Engine Active`;
                document.getElementById('send-btn').disabled = false;
                lucide.createIcons();
                
                addMessage('system', `Loaded <b>${models.find(m=>m.id===modelId).name}</b>. Memory OK.`);

            } catch (err) {
                clearInterval(dlInterval);
                btn.disabled = false;
                btn.className = "w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2";
                btn.innerHTML = `<i data-lucide="alert-triangle"></i> Init Failed (Retry)`;
                lucide.createIcons();
                alert("Error: " + err.message + "\n\nIf you are on mobile, try selecting 'Qwen Turbo'.");
            }
        }

        // --- 5. IMAGE & SEARCH TOOLS ---
        function generateImage(prompt) {
            const id = Date.now();
            const clean = prompt.replace(/imagine|generate/gi, '').trim();
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(clean)}?seed=${id}&nologo=true&width=1024&height=768`;
            
            const div = document.createElement('div');
            div.className = "msg-enter flex justify-start mb-6 w-full";
            div.innerHTML = `
                <div class="bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden max-w-lg w-full shadow-2xl">
                    <div class="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                        <span class="text-xs font-mono text-cyan-400">üé® ART_GEN_MODULE</span>
                        <i data-lucide="loader" class="w-4 h-4 animate-spin text-slate-500" id="spin-${id}"></i>
                    </div>
                    <div class="relative min-h-[300px] bg-slate-950 flex items-center justify-center group">
                        <img src="${url}" class="w-full h-auto object-cover opacity-0 transition-opacity duration-700"
                             onload="this.style.opacity=1; document.getElementById('spin-${id}').remove()"
                             onerror="this.parentElement.innerHTML='<span class=\'text-red-500 text-sm\'>Generation Error</span>'">
                    </div>
                </div>`;
            document.getElementById('chat-container').appendChild(div);
            lucide.createIcons();
            scrollToBottom();
        }

        async function searchWeb(query) {
            try {
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://html.duckduckgo.com/html/?q=' + query)}`);
                const data = await res.json();
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.contents, 'text/html');
                const snippets = Array.from(doc.querySelectorAll('.result__body')).slice(0, 3).map(e => e.innerText.trim());
                return snippets.length ? snippets.join('\n\n') : null;
            } catch { return null; }
        }

        // --- 6. MAIN CHAT & MATH FORMATTING ---
        window.handleSend = async function() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;

            // Smart Suggestion Trigger
            if(checkIntent(text)) {
                // If user ignores suggestion for 5s, we proceed? 
                // No, just show it. User can click or ignore.
                // We proceed with current generation anyway to avoid blocking.
            }

            if(text.toLowerCase().startsWith('imagine')) {
                input.value = '';
                addMessage('user', text);
                generateImage(text);
                return;
            }

            input.value = '';
            input.style.height = 'auto';
            addMessage('user', text);

            // Context Setup
            const useWeb = document.getElementById('web-toggle').checked;
            const useThink = document.getElementById('think-toggle').checked;
            let context = "";

            if(useWeb) {
                const loader = addMessage('system', 'üì° Scanning web nodes...');
                const results = await searchWeb(text);
                if(results) {
                    context = `[WEB_DATA_START]\n${results}\n[WEB_DATA_END]\n\n`;
                    loader.innerHTML = `‚úÖ Web Data Acquired`;
                } else {
                    loader.innerHTML = `‚ö†Ô∏è Web Uplink Failed. Using local cache.`;
                }
            }

            // Prompt Engineering
            let sys = "You are Nexus AI. Respond using Markdown. Use LaTeX for math (enclose in $$ for block, $ for inline).";
            if(useThink) sys += " SYSTEM_OVERRIDE: Engage Chain-of-Thought processing. Critique your answer before outputting.";
            
            const messages = [
                { role: "system", content: sys },
                { role: "user", content: context + text }
            ];

            // UI State
            const aiBubble = addMessage('ai', '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>');
            const contentDiv = aiBubble.querySelector('.content-area');
            const stats = document.getElementById('gen-stats');
            const timerDisplay = document.getElementById('timer-display');
            
            stats.classList.remove('hidden');
            let start = Date.now();
            clearInterval(genInterval);
            genInterval = setInterval(() => timerDisplay.innerText = ((Date.now()-start)/1000).toFixed(1) + 's', 100);

            try {
                const chunks = await engine.chat.completions.create({
                    messages,
                    stream: true,
                    temperature: useThink ? 0.6 : 0.7
                });

                let buffer = "";
                for await (const chunk of chunks) {
                    buffer += chunk.choices[0]?.delta?.content || "";
                    
                    // Render: Markdown -> HTML
                    contentDiv.innerHTML = marked.parse(buffer);
                    
                    // Render: Syntax Highlighting
                    Prism.highlightAllUnder(contentDiv);
                    
                    // Render: Math (KaTeX)
                    renderMathInElement(contentDiv, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false
                    });
                    
                    scrollToBottom();
                }
            } catch (e) {
                contentDiv.innerHTML += `<br><span class="text-red-400 font-bold">Runtime Error: ${e.message}</span>`;
            } finally {
                clearInterval(genInterval);
                stats.classList.add('hidden');
            }
        }

        function addMessage(role, html) {
            const div = document.createElement('div');
            div.className = `msg-enter flex ${role==='user'?'justify-end':'justify-start'} w-full`;
            
            if(role === 'system') {
                div.innerHTML = `<span class="text-[10px] font-mono text-slate-500 border border-slate-800 px-2 py-0.5 rounded bg-slate-900">${html}</span>`;
                div.className = "flex justify-center my-2";
            } else {
                const color = role==='user' ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-200 border border-slate-700';
                div.innerHTML = `
                    <div class="${color} max-w-[85%] md:max-w-2xl rounded-2xl ${role==='user'?'rounded-tr-none':'rounded-tl-none'} px-5 py-3 shadow-lg overflow-hidden">
                        <div class="content-area prose prose-invert prose-sm max-w-none leading-relaxed">${html}</div>
                    </div>
                `;
            }
            document.getElementById('chat-container').appendChild(div);
            scrollToBottom();
            return div;
        }

        function scrollToBottom() {
            const c = document.getElementById('chat-container');
            c.scrollTop = c.scrollHeight;
        }
    </script>
</body>
</html>
