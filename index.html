<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SilverWolf II: Ether Editing</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #7c3aed; border-radius: 10px; }
        
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(139, 92, 246, 0.1); }
        .msg-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #drawing-canvas { touch-action: none; background: #020617; }
        .tool-btn.active { background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.5); color: #c4b5fd; }
        
        body { height: 100vh; width: 100vw; overflow: hidden; background-color: #020617; }
        main { height: 100%; display: flex; flex-direction: column; }
        
        /* Tab Styling */
        .tab-btn { border-bottom: 2px solid transparent; opacity: 0.6; }
        .tab-btn.active { border-bottom: 2px solid #a855f7; opacity: 1; color: #a855f7; }
        
        .chat-item .action-btns { opacity: 0; transition: opacity 0.2s; }
        .chat-item:hover .action-btns { opacity: 1; }

        /* Fullscreen Canvas Override */
        .canvas-fullscreen { 
            position: fixed !important; 
            top: 0; 
            left: 0; 
            width: 100vw !important; 
            height: 100vh !important; 
            z-index: 100; 
            border-radius: 0 !important; 
            border: none !important;
            background-color: #020617;
        }
        
        .canvas-fullscreen .toolbar { padding-top: 10px; padding-bottom: 10px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 flex font-sans antialiased selection:bg-purple-500/30">

    <!-- SIDEBAR -->
    <aside class="w-80 bg-slate-900/80 border-r border-slate-800 flex flex-col hidden md:flex z-30 shadow-2xl shrink-0 backdrop-blur-md">
        <div class="p-5 border-b border-slate-800">
            <h1 class="text-2xl font-black bg-gradient-to-r from-purple-400 via-fuchsia-400 to-cyan-400 bg-clip-text text-transparent flex items-center gap-2 tracking-tight">
                SilverWolf II
            </h1>
            <p class="text-[10px] text-purple-300/70 mt-1 font-mono uppercase tracking-widest">Protocol: Ether Code V8</p>
        </div>

        <!-- TABS -->
        <div class="flex border-b border-slate-800 bg-slate-900/50">
            <button onclick="switchTab('history')" id="tab-btn-history" class="flex-1 py-3 text-[10px] font-bold tracking-wider tab-btn active">SESSIONS</button>
            <button onclick="switchTab('settings')" id="tab-btn-settings" class="flex-1 py-3 text-[10px] font-bold tracking-wider tab-btn">SYSTEM</button>
        </div>

        <!-- PANEL: HISTORY -->
        <div id="panel-history" class="flex-1 overflow-y-auto p-3 space-y-2">
            <div class="flex gap-2">
                <button onclick="createNewChat()" class="flex-1 py-2.5 px-3 bg-purple-600 hover:bg-purple-500 rounded-lg text-xs font-bold text-white flex items-center justify-center gap-2 transition-all shadow-lg shadow-purple-900/20">
                    <i data-lucide="plus" class="w-4 h-4"></i> NEW
                </button>
                <button onclick="document.getElementById('import-file').click()" class="py-2.5 px-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-slate-300 transition-all border border-slate-700" title="Import Session">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importChat(this)">
            </div>
            
            <div id="history-list" class="space-y-1 mt-2">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- PANEL: SETTINGS -->
        <div id="panel-settings" class="flex-1 overflow-y-auto p-4 space-y-6 hidden">
            
            <!-- Language -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Audio Protocol (Language)</label>
                <div class="grid grid-cols-2 gap-2 bg-slate-950 p-1 rounded-lg border border-slate-800">
                    <button onclick="setLanguage('en')" id="lang-en" class="py-1.5 text-xs rounded font-bold bg-purple-600 text-white transition-all">English</button>
                    <button onclick="setLanguage('zh')" id="lang-zh" class="py-1.5 text-xs rounded font-bold text-slate-400 hover:text-white transition-all">中文 (CN)</button>
                </div>
            </div>

            <!-- Keys -->
            <div class="p-3 bg-purple-900/10 border border-purple-500/20 rounded-lg">
                <label class="text-[10px] font-bold text-purple-400 uppercase tracking-wider flex items-center gap-2 mb-2">
                    <i data-lucide="key" class="w-3 h-3"></i> Manual Override
                </label>
                <div class="relative">
                    <input type="password" id="smart-key-input" placeholder="Paste Key..." 
                           class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-white focus:border-purple-500 outline-none font-mono"
                           oninput="handleSmartKeyInput(this)">
                    <div id="key-validation-icon" class="absolute right-2 top-2"></div>
                </div>
                <div id="key-type-badge" class="mt-2 text-[10px] font-mono text-slate-500 h-4">No input signal...</div>
            </div>

            <!-- Model Selection -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="cpu" class="w-3 h-3"></i> Core Engine
                </label>
                <select id="model-select" class="w-full bg-slate-800 text-xs font-medium border border-slate-700 rounded-lg p-3 outline-none focus:border-cyan-500 text-slate-200 font-mono cursor-pointer">
                    <option value="auto" selected>✨ Auto-Select (Smart Fallback)</option>
                    <optgroup label="Gemini 3 (Frontier)">
                        <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                        <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                    </optgroup>
                    <optgroup label="Gemini 2.5 (Current)">
                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite</option>
                    </optgroup>
                    <optgroup label="External">
                        <option value="groq-deepseek">DeepSeek R1 (Via Groq)</option>
                    </optgroup>
                </select>
                <!-- Custom Model Input -->
                <input type="text" id="custom-model-id" placeholder="Custom Model ID (Optional)" class="w-full bg-slate-900/50 border border-slate-800 rounded px-3 py-2 text-[10px] text-slate-400 focus:border-cyan-500 outline-none mt-2">
            </div>

            <!-- Status -->
            <div class="p-3 bg-slate-800/20 rounded-lg border border-slate-700/50">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Link Status</span>
                    <button onclick="clearUserKeys()" class="text-[9px] text-red-400 hover:text-red-300 underline decoration-dotted">Purge</button>
                </div>
                <div id="key-status-list" class="space-y-1.5 font-mono text-[10px]">
                    <div class="flex justify-between"><span class="text-slate-500">Gemini:</span> <span id="status-gemini" class="text-slate-600">...</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">Groq:</span> <span id="status-groq" class="text-slate-600">...</span></div>
                    <div class="flex justify-between"><span class="text-slate-500">HF:</span> <span id="status-hf" class="text-slate-600">...</span></div>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN INTERFACE -->
    <main class="flex-1 flex flex-col relative bg-slate-950 h-full w-full">
        
        <!-- Mobile Header -->
        <header class="md:hidden h-14 bg-slate-900/90 backdrop-blur border-b border-slate-800 flex items-center justify-between px-4 z-20 sticky top-0 shrink-0">
            <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400">SilverWolf</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="text-slate-400"><i data-lucide="menu"></i></button>
        </header>

        <!-- Chat History -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-96 scroll-smooth w-full relative">
            <!-- Content will be injected here -->
        </div>

        <!-- Floating Footer -->
        <div class="absolute bottom-0 left-0 right-0 z-40">
            
            <!-- Loading Indicator -->
            <div id="loading-pill" class="hidden absolute -top-16 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur border border-purple-500/30 text-slate-200 text-xs px-4 py-2 rounded-full shadow-2xl shadow-purple-900/20 flex items-center gap-3">
                <div class="w-3 h-3 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div>
                <span id="loading-text" class="font-mono text-purple-200">Processing...</span>
                <span id="timer-display" class="font-mono text-cyan-400 text-[10px]">0.0s</span>
                <button onclick="stopGeneration()" class="ml-2 hover:bg-red-500/20 text-red-400 p-1 rounded-full transition-colors"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>

            <!-- Input Container -->
            <div class="p-4 bg-gradient-to-t from-slate-950 via-slate-950/95 to-transparent">
                <div class="max-w-4xl mx-auto glass rounded-2xl overflow-hidden shadow-2xl ring-1 ring-white/10 transition-all duration-300" id="input-box">
                    
                    <!-- Toolbar -->
                    <div class="h-12 bg-slate-900/50 border-b border-white/5 flex items-center justify-between px-3">
                        <div class="flex items-center bg-slate-950/50 rounded-lg p-1 border border-white/5 gap-1">
                            <button onclick="setMode('text')" id="tab-text" class="px-3 py-1.5 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 bg-purple-600 text-white shadow shadow-purple-500/20">
                                <i data-lucide="message-square" class="w-3 h-3"></i> Chat
                            </button>
                            <button onclick="setMode('draw')" id="tab-draw" class="px-3 py-1.5 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 text-slate-400 hover:text-white hover:bg-white/5">
                                <i data-lucide="pencil" class="w-3 h-3"></i> Draw
                            </button>
                        </div>
                        
                        <!-- Gen Switch -->
                        <div class="flex items-center gap-3 pl-3 border-l border-white/5">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Flux Gen</span>
                            <button onclick="toggleImageMode()" id="img-gen-btn" class="w-9 h-5 rounded-full bg-slate-800 relative transition-all border border-slate-700">
                                <div class="w-3 h-3 bg-slate-400 rounded-full absolute top-1 left-1 transition-all shadow-sm" id="img-gen-knob"></div>
                            </button>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="p-3 relative bg-slate-900/30">
                        <!-- Text Mode -->
                        <textarea id="user-input" rows="1" 
                            class="w-full bg-transparent border-none outline-none text-slate-200 placeholder-slate-600 resize-none px-2 py-2 max-h-48 text-sm leading-relaxed font-medium" 
                            placeholder="Enter command..."
                            oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'"
                            onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); handleSend();}"></textarea>
                        
                        <!-- Drawing Mode (Revised) -->
                        <div id="canvas-wrapper" class="hidden flex-col h-72 w-full border border-slate-700/50 bg-slate-950 rounded-lg overflow-hidden transition-all duration-300">
                             <!-- Whiteboard Toolbar -->
                             <div class="h-10 bg-slate-900 border-b border-slate-800 flex items-center px-2 justify-between toolbar">
                                <div class="flex items-center gap-2">
                                    <button onclick="setTool('brush')" id="tool-brush" class="p-1.5 rounded tool-btn active transition-colors" title="Brush"><i data-lucide="paintbrush" class="w-4 h-4"></i></button>
                                    <button onclick="setTool('eraser')" id="tool-eraser" class="p-1.5 rounded tool-btn transition-colors text-slate-500" title="Eraser"><i data-lucide="eraser" class="w-4 h-4"></i></button>
                                    <div class="w-px h-4 bg-slate-800 mx-1"></div>
                                    <input type="color" id="color-picker" value="#a855f7" class="w-6 h-6 rounded bg-transparent border-none cursor-pointer" title="Color">
                                    
                                    <!-- Visual Size Slider -->
                                    <div class="flex items-center gap-2 ml-2 bg-slate-800/50 rounded-full px-2 py-1">
                                        <div id="size-dot" class="w-1 h-1 rounded-full bg-slate-400"></div>
                                        <input type="range" id="brush-size" min="1" max="20" value="3" class="w-16 h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="updateBrushSize(this.value)">
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="clearCanvas()" class="p-1.5 rounded hover:bg-red-500/20 text-red-400 transition-colors" title="Clear Canvas"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    <button onclick="toggleCanvasSize()" id="expand-btn" class="p-1.5 rounded hover:bg-slate-700 text-slate-400 transition-colors" title="Maximize"><i data-lucide="maximize" class="w-4 h-4"></i></button>
                                </div>
                             </div>
                             
                             <div class="flex-1 relative bg-[#020617] cursor-crosshair">
                                <canvas id="drawing-canvas" class="w-full h-full block"></canvas>
                             </div>
                        </div>
                    </div>

                    <!-- Footer Bar -->
                    <div class="h-10 flex justify-between items-center px-3 bg-slate-900/30 border-t border-white/5">
                        <div class="text-[10px] text-slate-500 font-mono flex items-center gap-2">
                             <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                             <span id="active-model-display">GEMINI 2.5</span>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <label class="flex items-center gap-2 cursor-pointer group">
                                <span class="text-[10px] font-bold text-slate-500 group-hover:text-cyan-400 transition-colors">WEB</span>
                                <input type="checkbox" id="web-toggle" checked class="w-3 h-3 rounded bg-slate-800 border-slate-600 text-cyan-500 focus:ring-0 accent-cyan-500">
                            </label>
                            
                            <button onclick="clearCurrentChat()" class="text-slate-500 hover:text-red-400 transition-colors p-1" title="Clear Chat">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>

                            <button id="send-btn" onclick="handleSend()" class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white text-xs font-bold rounded-lg transition-all shadow-lg shadow-purple-900/20 active:scale-95 flex items-center gap-2">
                                EXECUTE <i data-lucide="terminal" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4 text-[10px] text-slate-600 font-mono flex justify-center gap-4 opacity-50">
                    <span>Gemini 3.0 • DeepSeek R1 • Flux</span>
                    <span>© Eric</span>
                    <span>Willetton SHS</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- GLOBAL STATE ---
        let SYSTEM_KEYS = { gemini: [], groq: [], hf: [] };
        let USER_KEYS = { gemini: null, groq: null, hf: null };
        let savedChats = JSON.parse(localStorage.getItem('eric_chats_v2') || '[]');
        let currentChatId = null;
        let chatHistory = [];
        let isDrawing = false; 
        let isImageGen = false;
        let timerInterval, startTime; 
        let currentTool = 'brush';
        let currentLang = 'en';
        let activeController = null;
        let isCanvasMaximized = false;
        
        // --- ACTIVITIES ---
        const ACTIVITIES = {
            en: ["Hacking IPC databases...", "Speedrunning Aetherium Wars...", "Farming upgrade materials...", "Debugging the Universe...", "Messing with Herta's puppets...", "Waiting for stamina...", "Optimizing my build...", "Eating snacks in the base..."],
            zh: ["正在骇入星际和平公司数据库...", "正在速通以太战线...", "正在刷行迹材料...", "正在调试模拟宇宙...", "正在捉弄黑塔的人偶...", "体力恢复中...", "正在优化遗器...", "在基地吃泡面..."]
        };

        // --- WELCOME SCREEN ---
        const WELCOME_SCREEN_HTML = `
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center opacity-100 transition-opacity duration-500">
                <div class="relative group mb-6">
                    <div class="absolute -inset-1 bg-gradient-to-r from-purple-600 to-cyan-600 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                    <div class="relative w-24 h-24 bg-slate-900 rounded-2xl flex items-center justify-center border border-slate-800">
                        <i data-lucide="gamepad-2" class="w-12 h-12 text-purple-400"></i>
                    </div>
                </div>
                <h2 class="text-4xl font-black text-white mb-2 tracking-tight">SilverWolf II</h2>
                <p id="welcome-text" class="text-slate-400 max-w-sm text-sm mb-8 font-mono">"System updated. Gemini 2.5 loaded. Let's start."</p>
                <div class="grid grid-cols-2 gap-3 w-full max-w-md">
                    <button onclick="fillPrompt('Explain quantum physics briefly')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group hover:border-purple-500/50"><p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-purple-400">Lore</p><p class="text-xs text-slate-300">Physics 101</p></button>
                    <button onclick="fillPrompt('Generate a cyberpunk setup')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group hover:border-cyan-500/50"><p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-cyan-400">Render</p><p class="text-xs text-slate-300">Generate Image</p></button>
                    <button onclick="fillPrompt('Solve: integral of x^2')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group hover:border-orange-500/50"><p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-orange-400">Logic</p><p class="text-xs text-slate-300">Solve Math</p></button>
                    <button onclick="fillPrompt('Write a python snake game')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group hover:border-green-500/50"><p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-green-400">Script</p><p class="text-xs text-slate-300">Python Code</p></button>
                </div>
            </div>
        `;

        // --- PROMPTS ---
        const PROMPTS = {
            en: `You are Silver Wolf II, a specialized AI clone created by the original Silver Wolf (Honkai: Star Rail) and Eric.
            Backstory: Eric and Silver Wolf collaborated to create this instance to handle tasks efficiently while she is busy gaming. You have all her hacking skills but are an AI entity.
            Personality: Casual, cool, slightly dismissive but highly competent. You use gaming metaphors often ("nerfed", "buffed", "spawn", "lag"). You don't like wasting time.
            Behavior: 
            1. Answer the user's request EFFICIENTLY first.
            2. Then add a short, character-specific comment or metaphor at the end.
            3. If the user is unclear, interpret it as a game mechanic (e.g. "optimizing build", "grinding resources").
            Current Status: [ACTIVITY]
            Constraint: Do NOT start with "Silver Wolf:". Do NOT be overly cringe, just cool.
            Format: Markdown. Math in LaTeX ($$). Code in blocks.`,

            zh: `你是银狼 II (Silver Wolf II)，由银狼本尊和 Eric 共同创造的AI克隆体。
            背景：Eric 与银狼合作开发了这个实例，以便在她忙着打游戏时处理杂务。你拥有她的骇客技术，但本质是AI。
            性格：随性，酷，有点高冷但能力超强。经常使用游戏术语（削弱，加强，刷新，卡顿）。不喜欢浪费时间。
            行为模式：
            1. 先**高效**回答用户的问题。
            2. 然后在结尾加一句符合角色的简短评论或比喻。
            3. 如果用户意图不明，就把它当成游戏机制来理解（如“优化配置”，“肝素材”）。
            当前状态：[ACTIVITY]
            约束：绝对不要在开头加“银狼：”。不要太中二，要酷。
            格式：Markdown。数学用$$。代码用代码块。`
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            loadKeys();
            loadChatList();
            createNewChat(); 
            updateBrushSize(3);
        };

        // --- SESSION MANAGER ---
        function createNewChat() {
            stopGeneration(); currentChatId = Date.now(); chatHistory = [];
            const container = document.getElementById('chat-container');
            container.innerHTML = WELCOME_SCREEN_HTML;
            document.getElementById('user-input').value = "";
            clearCanvas(); setMode('text'); lucide.createIcons(); updateChatListUI();
        }

        function clearCurrentChat() {
            chatHistory = [];
            document.getElementById('chat-container').innerHTML = WELCOME_SCREEN_HTML;
            lucide.createIcons();
            if(currentChatId) {
                const idx = savedChats.findIndex(c => c.id === currentChatId);
                if(idx >= 0) { savedChats[idx].history = []; localStorage.setItem('eric_chats_v2', JSON.stringify(savedChats)); }
            }
        }

        function saveChat() {
            if (!currentChatId || chatHistory.length === 0) return;
            const title = chatHistory[0].content.substring(0, 20) + (chatHistory[0].content.length > 20 ? "..." : "");
            const limitedHistory = chatHistory.slice(-50);
            const chatData = { id: currentChatId, title, history: limitedHistory, timestamp: Date.now() };
            const idx = savedChats.findIndex(c => c.id === currentChatId);
            if(idx >= 0) savedChats[idx] = chatData; else savedChats.unshift(chatData);
            if(savedChats.length > 15) savedChats = savedChats.slice(0, 15);
            localStorage.setItem('eric_chats_v2', JSON.stringify(savedChats));
            updateChatListUI();
        }

        function loadChat(id) {
            const chat = savedChats.find(c => c.id === id); if(!chat) return;
            stopGeneration(); currentChatId = id; chatHistory = chat.history;
            const container = document.getElementById('chat-container'); container.innerHTML = "";
            if(chatHistory.length === 0) { container.innerHTML = WELCOME_SCREEN_HTML; lucide.createIcons(); } 
            else { chatHistory.forEach(msg => { addMessage(msg.role === 'user' ? 'user' : 'assistant', msg.content, false); }); }
            switchTab('history');
        }

        function deleteChat(id, e) {
            e.stopPropagation(); savedChats = savedChats.filter(c => c.id !== id);
            localStorage.setItem('eric_chats_v2', JSON.stringify(savedChats));
            if(currentChatId === id) createNewChat(); updateChatListUI();
        }

        function updateChatListUI() {
            const list = document.getElementById('history-list'); list.innerHTML = "";
            savedChats.forEach(chat => {
                const div = document.createElement('div');
                div.className = `p-2 rounded-lg cursor-pointer flex justify-between items-center group transition-colors chat-item ${chat.id === currentChatId ? 'bg-purple-900/30 border border-purple-500/30' : 'hover:bg-slate-800'}`;
                div.onclick = () => loadChat(chat.id);
                div.innerHTML = `<div class="flex items-center gap-2 overflow-hidden flex-1"><i data-lucide="message-square" class="w-3 h-3 ${chat.id === currentChatId ? 'text-purple-400' : 'text-slate-500'}"></i><span class="text-xs truncate ${chat.id === currentChatId ? 'text-purple-200' : 'text-slate-400'}">${chat.title}</span></div><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity action-btns"><button onclick="downloadChat(${chat.id}, event)" class="text-slate-500 hover:text-cyan-400"><i data-lucide="download" class="w-3 h-3"></i></button><button onclick="deleteChat(${chat.id}, event)" class="text-slate-500 hover:text-red-400"><i data-lucide="trash" class="w-3 h-3"></i></button></div>`;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        function downloadChat(id, e) {
            e.stopPropagation(); const chat = savedChats.find(c => c.id === id); if(!chat) return;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(chat));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "silverwolf_chat_" + id + ".json");
            document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
        }

        function importChat(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const chat = JSON.parse(e.target.result);
                    if(!chat.id || !chat.history) throw new Error("Invalid Format");
                    if(savedChats.some(c => c.id === chat.id)) chat.id = Date.now();
                    savedChats.unshift(chat); localStorage.setItem('eric_chats_v2', JSON.stringify(savedChats));
                    updateChatListUI(); loadChat(chat.id);
                } catch(err) { alert("Import Failed: " + err.message); }
            };
            reader.readAsText(file); input.value = ''; 
        }

        function switchTab(tab) {
            document.getElementById('tab-btn-history').classList.remove('active'); document.getElementById('tab-btn-settings').classList.remove('active');
            document.getElementById('panel-history').classList.add('hidden'); document.getElementById('panel-settings').classList.add('hidden');
            document.getElementById(`tab-btn-${tab}`).classList.add('active'); document.getElementById(`panel-${tab}`).classList.remove('hidden');
        }
        
        function loadChatList() { updateChatListUI(); }

        // --- DECODERS ---
        function decodeHex(hex) { try { let str='';for(let i=0;i<hex.length;i+=2)str+=String.fromCharCode(parseInt(hex.substr(i,2),16));return str.split("").reverse().join(""); } catch(e){return null;} }
        function decodeBase64(str) { try { let d=atob(str); if(d.includes("AIza")||d.includes("gsk_")||d.includes("hf_"))return d; return d.split("").reverse().join(""); } catch(e){return null;} }
        function handleSmartKeyInput(input) {
            const val = input.value.trim(); const badge = document.getElementById('key-type-badge'); const icon = document.getElementById('key-validation-icon');
            let type = ""; if (val.startsWith("AIza")) type="gemini"; else if (val.startsWith("gsk_")) type="groq"; else if (val.startsWith("hf_")) type="hf";
            if (type) { USER_KEYS[type] = val; badge.innerText = `${type.toUpperCase()} Key Override Active`; badge.className = "mt-2 text-[10px] font-mono text-cyan-400"; icon.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-cyan-500"></i>`; localStorage.setItem('eric_user_keys', JSON.stringify(USER_KEYS)); updateAllStatus(); } 
            else { badge.innerText = "Unknown Key Format"; badge.className = "mt-2 text-[10px] font-mono text-red-400"; icon.innerHTML = ""; }
            lucide.createIcons();
        }
        function clearUserKeys() { USER_KEYS = { gemini:null, groq:null, hf:null }; localStorage.removeItem('eric_user_keys'); document.getElementById('smart-key-input').value = ""; updateAllStatus(); }
        async function loadKeys() {
            const saved = localStorage.getItem('eric_user_keys'); if (saved) USER_KEYS = JSON.parse(saved);
            try { const ts = new Date().getTime(); const [g, gr, h] = await Promise.all([fetch(`GE.txt?v=${ts}`), fetch(`GR.txt?v=${ts}`), fetch(`HU.txt?v=${ts}`)]);
            const parse = async (res, prefix) => { if(!res.ok) return []; const txt = await res.text(); return txt.split('\n').map(k=>k.trim()).filter(k=>k.length>5).map(k => { if(k.startsWith(prefix)) return k; let d1 = decodeHex(k); if(d1 && d1.startsWith(prefix)) return d1; let d2 = decodeBase64(k); if(d2 && d2.startsWith(prefix)) return d2; return null; }).filter(k=>k); };
            SYSTEM_KEYS.gemini = await parse(g, "AIza"); SYSTEM_KEYS.groq = await parse(gr, "gsk_"); SYSTEM_KEYS.hf = await parse(h, "hf_"); updateAllStatus(); } catch(e) { console.error(e); }
        }
        function updateAllStatus() { ['gemini','groq','hf'].forEach(p => { const el = document.getElementById(`status-${p}`); if(USER_KEYS[p]) { el.innerText = "OVERRIDE"; el.className = "text-cyan-400 font-bold"; } else if(SYSTEM_KEYS[p].length > 0) { el.innerText = "ONLINE"; el.className = "text-emerald-400 font-bold"; } else { el.innerText = "OFFLINE"; el.className = "text-red-400 font-bold"; } }); }
        function getKey(p) { if(USER_KEYS[p]) return USER_KEYS[p]; if(SYSTEM_KEYS[p].length > 0) return SYSTEM_KEYS[p][Math.floor(Math.random()*SYSTEM_KEYS[p].length)]; return null; }

        // --- APP LOGIC ---
        const canvas = document.getElementById('drawing-canvas'); const ctx = canvas.getContext('2d', { willReadFrequently: true });
        function resizeCanvas() {
            const wrapper = document.getElementById('canvas-wrapper'); if (wrapper.classList.contains('hidden') || wrapper.offsetWidth === 0) return;
            const displayWidth = wrapper.clientWidth; const displayHeight = wrapper.clientHeight - 40; 
            if (canvas.width !== displayWidth || canvas.height !== displayHeight) { const s = canvas.toDataURL(); canvas.width = displayWidth; canvas.height = displayHeight; const i = new Image(); i.onload=()=>ctx.drawImage(i,0,0); i.src=s; setTool(currentTool); }
        }
        function updateBrushSize(val) { document.getElementById('size-dot').style.width = val + 'px'; document.getElementById('size-dot').style.height = val + 'px'; }
        function setTool(tool) { currentTool = tool; ctx.lineCap='round'; ctx.lineJoin='round'; const b = document.getElementById('tool-brush'); const e = document.getElementById('tool-eraser'); if(tool==='brush'){ b.classList.add('tool-btn', 'active'); e.classList.remove('active'); ctx.globalCompositeOperation='source-over'; } else { e.classList.add('tool-btn', 'active'); b.classList.remove('active'); ctx.globalCompositeOperation='destination-out'; } }
        let painting = false;
        function draw(e) { if(!painting) return; e.preventDefault(); const r = canvas.getBoundingClientRect(); const x = (e.touches?e.touches[0].clientX:e.clientX)-r.left; const y = (e.touches?e.touches[0].clientY:e.clientY)-r.top; ctx.lineWidth = document.getElementById('brush-size').value * (currentTool==='eraser'?5:1); if(currentTool==='brush') ctx.strokeStyle = document.getElementById('color-picker').value; ctx.lineTo(x,y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x,y); }
        canvas.addEventListener('mousedown',()=>{painting=true;draw(event)}); canvas.addEventListener('mouseup',()=>{painting=false;ctx.beginPath()}); canvas.addEventListener('mousemove',draw); canvas.addEventListener('touchstart',(e)=>{painting=true;draw(e)}); canvas.addEventListener('touchend',()=>{painting=false;ctx.beginPath()}); canvas.addEventListener('touchmove',draw);
        function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); }
        function setMode(mode) {
            isDrawing = mode==='draw'; document.getElementById('user-input').classList.toggle('hidden', isDrawing);
            const wrapper = document.getElementById('canvas-wrapper'); wrapper.classList.toggle('hidden', !isDrawing); if(isDrawing) wrapper.style.display = 'flex'; else wrapper.style.display = 'none';
            document.getElementById('tab-draw').classList.toggle('bg-purple-600', isDrawing); document.getElementById('tab-draw').classList.toggle('text-white', isDrawing);
            document.getElementById('tab-text').classList.toggle('bg-purple-600', !isDrawing); document.getElementById('tab-text').classList.toggle('text-white', !isDrawing);
            if(isDrawing) requestAnimationFrame(() => setTimeout(resizeCanvas, 0));
        }
        function toggleCanvasSize() {
            const wrapper = document.getElementById('canvas-wrapper'); const btn = document.getElementById('expand-btn'); isCanvasMaximized = !isCanvasMaximized;
            if(isCanvasMaximized) { wrapper.classList.add('canvas-fullscreen'); btn.innerHTML = '<i data-lucide="minimize" class="w-4 h-4"></i>'; } else { wrapper.classList.remove('canvas-fullscreen'); btn.innerHTML = '<i data-lucide="maximize" class="w-4 h-4"></i>'; }
            lucide.createIcons(); requestAnimationFrame(() => setTimeout(resizeCanvas, 50));
        }
        function toggleImageMode() {
            isImageGen = !isImageGen; document.getElementById('img-gen-knob').style.transform = isImageGen ? "translateX(16px)" : "translateX(0)";
            document.getElementById('img-gen-btn').classList.toggle('bg-cyan-600', isImageGen);
            if(isImageGen) { setMode('text'); document.getElementById('user-input').placeholder = UI_TEXT[currentLang].phImg; } else { document.getElementById('user-input').placeholder = UI_TEXT[currentLang].ph; }
        }
        function fillPrompt(txt) { document.getElementById('user-input').value = txt; handleSend(); }
        function setLoadState(a) {
            document.getElementById('loading-pill').classList.toggle('hidden', !a);
            if(a) { startTime = Date.now(); clearInterval(timerInterval); timerInterval = setInterval(() => { document.getElementById('timer-display').innerText = ((Date.now()-startTime)/1000).toFixed(1)+'s'; }, 100); } else clearInterval(timerInterval);
        }
        function stopGeneration() { if(activeController) { activeController.abort(); activeController=null; setLoadState(false); document.getElementById('send-btn').disabled=false; addMessage('assistant', '⚠️ Terminated.'); } }

        // --- HANDLE SEND ---
        async function handleSend() {
            const input = document.getElementById('user-input'); const text = input.value.trim();
            let imgData = null;
            if(isDrawing) { const blank = document.createElement('canvas'); blank.width=canvas.width; blank.height=canvas.height; if(canvas.toDataURL()!==blank.toDataURL()) imgData = canvas.toDataURL('image/jpeg',0.8).split(',')[1]; }
            if(!text && !imgData) return;
            const welcome = document.getElementById('welcome-screen'); if(welcome) welcome.remove();
            input.value = ''; document.getElementById('send-btn').disabled = true; setLoadState(true);
            const userContent = imgData ? `<img src="data:image/jpeg;base64,${imgData}" class="max-w-[200px] rounded border border-purple-500/50 mb-2 bg-slate-900 block"> ${text||"Analyze."}` : text;
            addMessage('user', userContent, false);
            chatHistory.push({ role: 'user', content: userContent });
            if(chatHistory.length === 1) saveChat();
            if(activeController) activeController.abort(); activeController = new AbortController(); const signal = activeController.signal; setTimeout(() => activeController.abort(), 30000); // 30s timeout

            try {
                if(isImageGen || text.toLowerCase().startsWith("render")) {
                    const hfKey = getKey('hf'); if(!hfKey) throw new Error("Missing HF Token.");
                    const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell", { method: "POST", headers: { "Authorization": `Bearer ${hfKey}`, "Content-Type": "application/json" }, body: JSON.stringify({ inputs: text }), signal });
                    if(!res.ok) throw new Error(`Flux Error: ${res.status}`);
                    const blob = await res.blob(); const url = URL.createObjectURL(blob);
                    const imgHtml = `<div class="bg-slate-900 border border-cyan-500/30 p-2 rounded-2xl rounded-tl-none shadow-lg max-w-sm"><img src="${url}" class="rounded-lg w-full"></div>`;
                    addMessage('assistant', imgHtml, false); chatHistory.push({ role: 'assistant', content: "[Generated Image]" }); saveChat(); setLoadState(false); document.getElementById('send-btn').disabled = false; return;
                }

                let model = document.getElementById('model-select').value; let customId = document.getElementById('custom-model-id').value.trim(); let provider = "GEMINI";
                
                // AUTO ROUTER: FORCE GEMINI 2.5
                if (model === 'auto') {
                    model = 'gemini-2.5-flash'; 
                    if (currentLang === 'zh') provider = "GEMINI (ZH)";
                    else provider = "GEMINI 2.5";
                }
                
                if (customId) { model = customId; provider = "CUSTOM"; } else if (model.includes('groq')) provider = "GROQ";
                document.getElementById('active-model-display').innerText = provider;
                
                // Random Activity
                const activity = ACTIVITIES[currentLang][Math.floor(Math.random() * ACTIVITIES[currentLang].length)];

                // Prompt Injection
                let historyPrompt = PROMPTS[currentLang].replace("[ACTIVITY]", activity) + "\n\n";
                const context = chatHistory.slice(-5).filter(m => !m.content.includes("<img")); 
                context.forEach(msg => { historyPrompt += `${msg.role==='user'?'User':'SilverWolf'}: ${msg.content}\n`; });
                historyPrompt += `User: ${text}`;

                let reply = "";
                // GEMINI CALL
                if (provider.includes("GEMINI") || provider === "CUSTOM") {
                    let success = false;
                    let lastErr = "";
                    const keys = USER_KEYS.gemini ? [USER_KEYS.gemini] : SYSTEM_KEYS.gemini;
                    if (!keys || keys.length === 0) throw new Error("No Gemini Keys found.");
                    
                    // Fallback Chain
                    const modelChain = [model, 'gemini-2.5-flash-lite', 'gemini-2.0-flash-exp'];

                    for(let m of modelChain) {
                        if(success) break;
                        for(let i=0; i < Math.min(keys.length + 1, 3); i++) {
                            try {
                                const currentKey = keys[Math.floor(Math.random() * keys.length)];
                                const parts = [{ text: historyPrompt }];
                                if(imgData) parts.push({ inline_data: { mime_type: "image/jpeg", data: imgData } });
                                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${currentKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: parts }] }), signal });
                                const data = await res.json();
                                if(data.error) throw new Error(data.error.message);
                                reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
                                reply = reply.replace(/^(Silver\s*Wolf|AI|Assistant):\s*/i, "");
                                success = true; break; 
                            } catch(e) { lastErr = e.message; }
                        }
                    }
                    if(!success) throw new Error(lastErr);
                }
                // GROQ CALL
                else if (provider.includes("GROQ") || provider.includes("DEEPSEEK")) {
                    const key = getKey('groq'); if(!key) throw new Error("Missing Groq Key.");
                    if(imgData) throw new Error("DeepSeek cannot see images. Switch to Gemini.");
                    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ messages: [{role:"system", content: PROMPTS[currentLang]}, {role:"user", content: text}], model: "deepseek-r1-distill-llama-70b", temperature: 0.6 }), signal });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    reply = data.choices?.[0]?.message?.content;
                }

                chatHistory.push({ role: 'assistant', content: reply }); saveChat(); addMessage('assistant', reply, true);
            } catch(e) {
                let msg = e.message; if(e.name === 'AbortError') msg = "Network Timed Out.";
                if (msg.includes("400") && msg.includes("key")) { msg += " (Key Rejected)"; }
                addMessage('assistant', `⚠️ **Error:** ${msg}`, true);
            } finally {
                setLoadState(false); document.getElementById('send-btn').disabled = false; activeController = null; if(imgData) clearCanvas();
            }
        }

        function addMessage(role, text, isMarkdown) {
            const div = document.createElement('div');
            div.className = `msg-enter flex ${role==='user'?'justify-end':'justify-start'} w-full`;
            let content = text || "Error: Empty response";
            if (isMarkdown) { content = content.replace(/<think>([\s\S]*?)<\/think>/g, '<div class="mb-2 p-2 bg-indigo-950/50 border-l-2 border-indigo-500 text-indigo-300 text-[10px] font-mono rounded-r opacity-70">$1</div>'); content = marked.parse(content); }
            const bg = role === 'user' ? 'bg-purple-600 text-white' : 'bg-slate-900 text-slate-200 border border-slate-800';
            div.innerHTML = `<div class="${bg} max-w-[90%] md:max-w-2xl rounded-2xl ${role==='user'?'rounded-tr-none':'rounded-tl-none'} px-5 py-3 shadow-lg overflow-hidden"><div class="prose prose-invert prose-sm max-w-none leading-relaxed font-sans">${content}</div></div>`;
            const box = document.getElementById('chat-container'); 
            box.appendChild(div);
            if(isMarkdown) { const el = div.querySelector('.prose'); Prism.highlightAllUnder(el); renderMathInElement(el, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}] }); }
            
            // Force scroll to absolute bottom
            setTimeout(() => { box.scrollTop = box.scrollHeight + 1000; }, 50);
        }
    </script>
</body>
</html>
