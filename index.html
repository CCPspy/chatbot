<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eric II: Neural Interface</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .msg-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #drawing-canvas { cursor: crosshair; touch-action: none; background: #1e293b; border-radius: 8px; }
        .tool-active { background: rgba(99, 102, 241, 0.2); border-color: rgba(99, 102, 241, 0.5); color: #818cf8; }
        
        body { height: 100vh; width: 100vw; overflow: hidden; }
        main { height: 100%; display: flex; flex-direction: column; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 flex font-sans antialiased selection:bg-indigo-500/30">

    <!-- SIDEBAR -->
    <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col hidden md:flex z-30 shadow-2xl shrink-0">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-2xl font-black bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 bg-clip-text text-transparent flex items-center gap-2 tracking-tight">
                Eric II
            </h1>
            <p class="text-[10px] text-slate-500 mt-1 font-mono uppercase tracking-widest">Multi-Agent System</p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <!-- Manual Keys -->
            <div class="p-3 bg-indigo-900/10 border border-indigo-500/20 rounded-lg">
                <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-2 mb-2">
                    <i data-lucide="key" class="w-3 h-3"></i> Manual Keys
                </label>
                <div class="relative">
                    <input type="password" id="smart-key-input" placeholder="Paste ANY API Key here..." 
                           class="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-xs text-white focus:border-indigo-500 outline-none transition-colors"
                           oninput="handleSmartKeyInput(this)">
                    <div id="key-validation-icon" class="absolute right-2 top-2"></div>
                </div>
                <div id="key-type-badge" class="mt-2 text-[10px] font-mono text-slate-500 h-4">Awaiting Input...</div>
                <p class="text-[9px] text-slate-500 mt-1 leading-tight border-t border-slate-800 pt-1 mt-1">
                    Supports: Gemini (AIza...), Groq (gsk_...), HF (hf_...).
                </p>
            </div>

            <!-- Model Selection -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="cpu" class="w-3 h-3"></i> Engine
                </label>
                <select id="model-select" class="w-full bg-slate-800 text-xs font-medium border border-slate-700 rounded-lg p-3 outline-none focus:border-indigo-500 transition-colors cursor-pointer text-slate-200 shadow-sm">
                    <option value="auto" selected>✨ Auto-Select (Smartest)</option>
                    <optgroup label="Manual Override">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Newest)</option>
                        <option value="gemini-1.5-flash-002">Gemini 1.5 Flash-002 (Stable)</option>
                        <option value="gemini-1.5-pro-002">Gemini 1.5 Pro-002 (Smart)</option>
                        <option value="groq-deepseek">DeepSeek R1 (Math/Logic)</option>
                        <option value="groq-llama">Llama 3 (General)</option>
                    </optgroup>
                </select>
            </div>

            <!-- Key Status Indicator -->
            <div class="p-3 bg-slate-800/20 rounded-lg border border-slate-700/50">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Active Credentials</span>
                    <button onclick="clearUserKeys()" class="text-[9px] text-red-400 hover:text-red-300 underline">Reset User Keys</button>
                </div>
                <div id="key-status-list" class="space-y-1.5">
                    <div class="flex justify-between text-[10px] items-center">
                        <span class="text-slate-500">Gemini:</span> 
                        <span id="status-gemini" class="px-1.5 py-0.5 rounded bg-slate-800 text-slate-500">Checking...</span>
                    </div>
                    <div class="flex justify-between text-[10px] items-center">
                        <span class="text-slate-500">Groq:</span> 
                        <span id="status-groq" class="px-1.5 py-0.5 rounded bg-slate-800 text-slate-500">Checking...</span>
                    </div>
                    <div class="flex justify-between text-[10px] items-center">
                        <span class="text-slate-500">HF:</span> 
                        <span id="status-hf" class="px-1.5 py-0.5 rounded bg-slate-800 text-slate-500">Checking...</span>
                    </div>
                </div>
            </div>

            <!-- Encoder Tool -->
            <div class="pt-2 border-t border-slate-800">
                <button onclick="document.getElementById('encoder-tool').classList.toggle('hidden')" class="text-[10px] text-slate-600 hover:text-indigo-400 w-full text-left flex items-center gap-2">
                    <i data-lucide="lock" class="w-3 h-3"></i> Key Encrypter Tool
                </button>
                <div id="encoder-tool" class="hidden mt-2 p-2 bg-slate-900 border border-slate-800 rounded">
                    <input type="text" id="raw-key-input" placeholder="Paste Plain Key Here" class="w-full bg-slate-950 border border-slate-800 text-[10px] p-1 text-white mb-1">
                    <button onclick="encodeAndShow()" class="w-full bg-indigo-600 text-white text-[10px] py-1 rounded hover:bg-indigo-500 transition-colors">Encrypt (Hex)</button>
                    <p id="encoded-output" class="text-[10px] text-green-400 mt-1 break-all select-all font-mono bg-slate-950 p-1 rounded min-h-[20px]"></p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN INTERFACE -->
    <main class="flex-1 flex flex-col relative bg-slate-950 h-full w-full">
        <header class="md:hidden h-14 bg-slate-900/90 backdrop-blur border-b border-slate-800 flex items-center justify-between px-4 z-20 sticky top-0 shrink-0">
            <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">Eric II</span>
            <button onclick="document.querySelector('aside').classList.toggle('hidden')" class="text-slate-400"><i data-lucide="menu"></i></button>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-64 scroll-smooth w-full">
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center opacity-100 transition-opacity duration-500">
                <div class="relative group mb-6">
                    <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full blur opacity-25 group-hover:opacity-50 transition duration-1000"></div>
                    <div class="relative w-20 h-20 bg-slate-900 rounded-full flex items-center justify-center border border-slate-800">
                        <i data-lucide="brain-circuit" class="w-10 h-10 text-indigo-400"></i>
                    </div>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2">Eric II</h2>
                <p class="text-slate-400 max-w-sm text-sm mb-8">System Online. Paste API keys in the sidebar if system keys fail.</p>
                
                <div class="grid grid-cols-2 gap-3 w-full max-w-md">
                    <button onclick="fillPrompt('Explain quantum physics')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-blue-400">Knowledge</p>
                        <p class="text-xs text-slate-300">Explain Physics</p>
                    </button>
                    <button onclick="fillPrompt('Imagine a futuristic city')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-purple-400">Flux Art</p>
                        <p class="text-xs text-slate-300">Generate Image</p>
                    </button>
                    <button onclick="fillPrompt('Solve: integral of x^2')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-orange-400">DeepSeek</p>
                        <p class="text-xs text-slate-300">Solve Math</p>
                    </button>
                    <button onclick="fillPrompt('Write a python snake game')" class="p-3 bg-slate-900/50 hover:bg-slate-800 border border-slate-800 rounded-lg text-left transition-colors group">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-1 group-hover:text-green-400">Coding</p>
                        <p class="text-xs text-slate-300">Write Code</p>
                    </button>
                </div>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 z-40">
            <div id="loading-pill" class="hidden absolute -top-14 left-1/2 -translate-x-1/2 bg-slate-900/90 backdrop-blur border border-slate-700/50 text-slate-200 text-xs px-4 py-2 rounded-full shadow-xl flex items-center gap-3">
                <div class="w-3 h-3 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                <span id="loading-text">Processing...</span>
                <span id="timer-display" class="font-mono text-indigo-400 text-[10px]">0.0s</span>
                <button onclick="stopGeneration()" class="ml-2 bg-red-500/20 hover:bg-red-500/40 text-red-400 p-1 rounded-full"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>

            <div class="p-4 bg-gradient-to-t from-slate-950 via-slate-950/95 to-transparent">
                <div class="max-w-4xl mx-auto glass rounded-2xl overflow-hidden shadow-2xl ring-1 ring-white/10 transition-all duration-300" id="input-box">
                    <div class="h-11 bg-slate-900/50 border-b border-white/5 flex items-center justify-between px-3">
                        <div class="flex items-center bg-slate-950/50 rounded-lg p-1 border border-white/5">
                            <button onclick="setMode('text')" id="tab-text" class="px-3 py-1 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 bg-slate-800 text-white shadow"><i data-lucide="type" class="w-3 h-3"></i> Text</button>
                            <button onclick="setMode('draw')" id="tab-draw" class="px-3 py-1 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 text-slate-500 hover:text-slate-300"><i data-lucide="pencil" class="w-3 h-3"></i> Draw</button>
                        </div>
                        <div class="flex items-center gap-2 pl-3 border-l border-white/5">
                            <span class="text-[10px] font-bold text-slate-500 uppercase">Create Image</span>
                            <button onclick="toggleImageMode()" id="img-gen-btn" class="w-8 h-4 rounded-full bg-slate-800 relative transition-colors border border-slate-700">
                                <div class="w-2 h-2 bg-slate-400 rounded-full absolute top-1 left-1 transition-transform shadow-sm" id="img-gen-knob"></div>
                            </button>
                        </div>
                    </div>

                    <div class="p-3 relative bg-slate-900/30">
                        <textarea id="user-input" rows="1" class="w-full bg-transparent border-none outline-none text-slate-200 placeholder-slate-600 resize-none px-2 py-1 max-h-48 text-sm leading-relaxed" placeholder="Type a message..." oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); handleSend();}"></textarea>
                        <div id="canvas-container" class="hidden h-72 w-full relative rounded-lg overflow-hidden border border-slate-800 bg-slate-950">
                            <canvas id="drawing-canvas" class="w-full h-full"></canvas>
                            <div class="absolute top-3 left-3 flex flex-col gap-2 bg-slate-900/90 p-2 rounded-lg backdrop-blur border border-slate-800 shadow-xl">
                                <button onclick="setTool('brush')" id="tool-brush" class="p-2 rounded tool-active"><i data-lucide="paintbrush" class="w-4 h-4"></i></button>
                                <button onclick="setTool('eraser')" id="tool-eraser" class="p-2 rounded text-slate-500 hover:bg-slate-800"><i data-lucide="eraser" class="w-4 h-4"></i></button>
                                <div class="h-px w-full bg-slate-800 my-1"></div>
                                <input type="color" id="color-picker" value="#ffffff" class="w-6 h-6 rounded bg-transparent border-none cursor-pointer">
                                <input type="range" id="brush-size" min="1" max="20" value="3" class="w-6 h-20 writing-mode-vertical appearance-none bg-slate-800 rounded-full overflow-hidden [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-full [&::-webkit-slider-thumb]:h-2 [&::-webkit-slider-thumb]:bg-indigo-500">
                            </div>
                            <button onclick="clearCanvas()" class="absolute top-3 right-3 p-2 bg-slate-900/90 rounded-lg text-red-400 hover:bg-red-500/20 border border-slate-800 transition-colors" title="Clear"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>

                    <div class="h-10 flex justify-between items-center px-3 bg-slate-900/30 border-t border-white/5">
                        <div class="text-[10px] text-slate-600 font-mono flex items-center gap-2"><span id="active-model-display" class="px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20">AUTO-ROUTING</span><span class="hidden md:inline">|</span><span class="hidden md:inline">History: Auto-Clear</span></div>
                        <button id="send-btn" onclick="handleSend()" class="px-4 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition-all shadow-lg shadow-indigo-900/20 active:scale-95 flex items-center gap-2">SEND <i data-lucide="arrow-up" class="w-3 h-3"></i></button>
                    </div>
                </div>
                <div class="text-center mt-4 text-[10px] text-slate-600 font-mono flex justify-center gap-4"><span>Powered by Gemini • HuggingFace • Groq</span><span>© Eric</span><span>From Willetton SHS</span></div>
            </div>
        </div>
    </main>

    <script>
        let SYSTEM_KEYS = { gemini: [], groq: [], hf: [] };
        let USER_KEYS = { gemini: null, groq: null, hf: null };
        let activeController = null;

        // --- SMART DECODERS ---
        function decodeHex(hex) {
            try {
                let str = '';
                for (let i = 0; i < hex.length; i += 2) str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
                return str.split("").reverse().join("");
            } catch (e) { return null; }
        }
        function decodeBase64(str) {
            try {
                let decoded = atob(str);
                if (decoded.includes("AIza") || decoded.includes("gsk_") || decoded.includes("hf_")) return decoded;
                return decoded.split("").reverse().join("");
            } catch(e) { return null; }
        }
        function secureEncode(text) {
            let reversed = text.split("").reverse().join("");
            let hex = '';
            for(let i=0;i<reversed.length;i++) hex += reversed.charCodeAt(i).toString(16).padStart(2, '0');
            return hex;
        }
        function encodeAndShow() {
            const raw = document.getElementById('raw-key-input').value;
            if(raw) document.getElementById('encoded-output').innerText = secureEncode(raw);
        }

        // --- KEY MANAGEMENT ---
        function handleSmartKeyInput(input) {
            const val = input.value.trim();
            const badge = document.getElementById('key-type-badge');
            const icon = document.getElementById('key-validation-icon');
            
            const isGemini = val.startsWith("AIza");
            const isGroq = val.startsWith("gsk_");
            const isHF = val.startsWith("hf_");

            if (isGemini) {
                USER_KEYS.gemini = val;
                badge.innerText = "Valid Gemini Key Detected";
                badge.className = "mt-2 text-[10px] font-mono text-blue-400 font-bold";
                icon.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>`;
            } else if (isGroq) {
                USER_KEYS.groq = val;
                badge.innerText = "Valid Groq Key Detected";
                badge.className = "mt-2 text-[10px] font-mono text-orange-400 font-bold";
                icon.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>`;
            } else if (isHF) {
                USER_KEYS.hf = val;
                badge.innerText = "Valid Hugging Face Token";
                badge.className = "mt-2 text-[10px] font-mono text-yellow-400 font-bold";
                icon.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>`;
            } else if (val.length > 5) {
                badge.innerText = "Invalid Key Format";
                badge.className = "mt-2 text-[10px] font-mono text-red-400 font-bold";
                icon.innerHTML = `<i data-lucide="x-circle" class="w-4 h-4 text-red-500"></i>`;
            } else {
                badge.innerText = "Awaiting Input...";
                badge.className = "mt-2 text-[10px] font-mono text-slate-500";
                icon.innerHTML = "";
            }
            
            lucide.createIcons();
            localStorage.setItem('eric_user_keys', JSON.stringify(USER_KEYS));
            updateAllStatus();
        }

        function clearUserKeys() {
            USER_KEYS = { gemini: null, groq: null, hf: null };
            localStorage.removeItem('eric_user_keys');
            document.getElementById('smart-key-input').value = "";
            document.getElementById('key-type-badge').innerText = "Awaiting Input...";
            document.getElementById('key-validation-icon').innerHTML = "";
            updateAllStatus();
        }

        async function loadKeys() {
            const saved = localStorage.getItem('eric_user_keys');
            if (saved) USER_KEYS = JSON.parse(saved);
            try {
                const ts = new Date().getTime();
                const [geminiRes, groqRes, hfRes] = await Promise.all([
                    fetch(`GE.txt?v=${ts}`, { cache: "no-store" }), 
                    fetch(`GR.txt?v=${ts}`, { cache: "no-store" }), 
                    fetch(`HU.txt?v=${ts}`, { cache: "no-store" })
                ]);
                const processKeys = async (res, prefix) => {
                    if(!res.ok) return [];
                    const text = await res.text();
                    const lines = text.split('\n').map(k => k.trim()).filter(k => k.length > 5);
                    let validKeys = [];
                    for(let line of lines) {
                        if (line.startsWith(prefix)) { validKeys.push(line); continue; }
                        let k1 = decodeHex(line); if(k1 && k1.startsWith(prefix)) { validKeys.push(k1); continue; }
                        let k2 = decodeBase64(line); if(k2 && k2.startsWith(prefix)) { validKeys.push(k2); continue; }
                    }
                    return validKeys;
                };
                SYSTEM_KEYS.gemini = await processKeys(geminiRes, "AIza");
                SYSTEM_KEYS.groq = await processKeys(groqRes, "gsk_");
                SYSTEM_KEYS.hf = await processKeys(hfRes, "hf_");
                updateAllStatus();
            } catch (error) { console.error("System Key Load Error", error); }
        }

        function updateAllStatus() {
            updateStatus('gemini'); updateStatus('groq'); updateStatus('hf');
        }
        function updateStatus(provider) {
            const el = document.getElementById(`status-${provider}`);
            if (USER_KEYS[provider]) {
                el.innerText = "User Key"; el.className = "px-1.5 py-0.5 rounded bg-blue-500/20 text-blue-400 border border-blue-500/30";
            } else if (SYSTEM_KEYS[provider] && SYSTEM_KEYS[provider].length > 0) {
                el.innerText = "System Ready"; el.className = "px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400 border border-emerald-500/30";
            } else {
                el.innerText = "Missing"; el.className = "px-1.5 py-0.5 rounded bg-red-500/20 text-red-400 border border-red-500/30";
            }
        }
        function getKey(provider) {
            if (USER_KEYS[provider]) return USER_KEYS[provider];
            const keys = SYSTEM_KEYS[provider];
            if (!keys || keys.length === 0) return null;
            return keys[Math.floor(Math.random() * keys.length)];
        }

        // --- CORE APP LOGIC ---
        let chatHistory = [];
        let isDrawing = false; let isImageGen = false;
        let timerInterval, startTime; let currentTool = 'brush';
        const SYS_PROMPT = "You are Eric II. You are an advanced AI assistant. You can see drawings sent by the user. Be concise, helpful, and accurate. Use Markdown. For math, use LaTeX ($$).";

        // Canvas
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        let painting = false;
        function resizeCanvas() {
            const container = document.getElementById('canvas-container'); const rect = container.getBoundingClientRect();
            if (canvas.width !== rect.width || canvas.height !== rect.height) {
                const saved = canvas.toDataURL(); canvas.width = rect.width; canvas.height = rect.height;
                const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = saved; setTool(currentTool);
            }
        }
        function setTool(tool) {
            currentTool = tool; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            const bBtn = document.getElementById('tool-brush'); const eBtn = document.getElementById('tool-eraser');
            if (tool === 'brush') {
                bBtn.className = "p-2 rounded tool-active"; eBtn.className = "p-2 rounded text-slate-500 hover:bg-slate-800"; ctx.globalCompositeOperation = 'source-over';
            } else {
                eBtn.className = "p-2 rounded tool-active"; bBtn.className = "p-2 rounded text-slate-500 hover:bg-slate-800"; ctx.globalCompositeOperation = 'destination-out';
            }
        }
        function draw(e) {
            if (!painting) return; e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            ctx.lineWidth = document.getElementById('brush-size').value * (currentTool === 'eraser' ? 4 : 1);
            if(currentTool === 'brush') ctx.strokeStyle = document.getElementById('color-picker').value;
            ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
        }
        canvas.addEventListener('mousedown', (e) => { painting = true; draw(e); }); canvas.addEventListener('mouseup', () => { painting = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw); canvas.addEventListener('touchstart', (e) => { painting = true; draw(e); });
        canvas.addEventListener('touchend', () => { painting = false; ctx.beginPath(); }); canvas.addEventListener('touchmove', draw);
        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        // UI
        function setMode(mode) {
            const textBox = document.getElementById('user-input'); const canvasBox = document.getElementById('canvas-container');
            const tabT = document.getElementById('tab-text'); const tabD = document.getElementById('tab-draw');
            if (mode === 'draw') {
                isDrawing = true; textBox.classList.add('hidden'); canvasBox.classList.remove('hidden');
                tabD.className = "px-3 py-1 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 bg-slate-800 text-white shadow";
                tabT.className = "px-3 py-1 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 text-slate-500 hover:text-slate-300";
                setTimeout(resizeCanvas, 50);
            } else {
                isDrawing = false; textBox.classList.remove('hidden'); canvasBox.classList.add('hidden');
                tabT.className = "px-3 py-1 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 bg-slate-800 text-white shadow";
                tabD.className = "px-3 py-1 rounded text-[10px] font-bold uppercase transition-all flex items-center gap-2 text-slate-500 hover:text-slate-300";
            }
        }
        function toggleImageMode() {
            isImageGen = !isImageGen;
            const knob = document.getElementById('img-gen-knob'); const btn = document.getElementById('img-gen-btn'); const input = document.getElementById('user-input');
            if (isImageGen) {
                knob.style.transform = "translateX(16px)"; knob.classList.replace('bg-slate-400', 'bg-white');
                btn.classList.replace('bg-slate-800', 'bg-purple-600'); btn.classList.replace('border-slate-700', 'border-purple-500');
                input.placeholder = "Describe image..."; setMode('text');
            } else {
                knob.style.transform = "translateX(0)"; knob.classList.replace('bg-white', 'bg-slate-400');
                btn.classList.replace('bg-purple-600', 'bg-slate-800'); btn.classList.replace('border-purple-500', 'border-slate-700');
                input.placeholder = "Type a message...";
            }
        }
        function fillPrompt(txt) { document.getElementById('user-input').value = txt; handleSend(); }
        function setLoadState(active) {
            const pill = document.getElementById('loading-pill'); const text = document.getElementById('loading-text'); const timeDisplay = document.getElementById('timer-display');
            if (active) {
                pill.classList.remove('hidden'); text.innerText = "Processing..."; startTime = Date.now();
                clearInterval(timerInterval); timerInterval = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000; timeDisplay.innerText = elapsed.toFixed(1) + "s";
                    if (elapsed > 2) text.innerText = "Thinking..."; if (elapsed > 8) text.innerText = "Generating...";
                }, 100);
            } else { pill.classList.add('hidden'); clearInterval(timerInterval); }
        }

        function stopGeneration() {
            if (activeController) {
                activeController.abort();
                activeController = null;
                setLoadState(false);
                document.getElementById('send-btn').disabled = false;
                addMessage('assistant', '⚠️ Generation stopped by user.');
            }
        }

        // Logic
        async function handleSend() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const btn = document.getElementById('send-btn');
            const activeBadge = document.getElementById('active-model-display');
            
            let imgData = null;
            if (isDrawing) {
                const temp = document.createElement('canvas'); temp.width = canvas.width; temp.height = canvas.height;
                if (canvas.toDataURL() !== temp.toDataURL()) imgData = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            }
            if (!text && !imgData) return;

            document.getElementById('welcome-screen').style.display = 'none';
            input.value = ''; btn.disabled = true; setLoadState(true);

            if (imgData) {
                addMessage('user', `<img src="data:image/jpeg;base64,${imgData}" class="max-w-[200px] rounded border border-indigo-400 mb-2 bg-white block"> ${text || "Analyze this."}`);
                clearCanvas();
            } else { addMessage('user', text); }

            // Create new controller
            if (activeController) activeController.abort();
            activeController = new AbortController();
            const signal = activeController.signal;
            const timeoutId = setTimeout(() => activeController.abort(), 30000); // 30s Timeout

            try {
                // IMAGE GEN
                if (isImageGen || text.toLowerCase().startsWith("imagine")) {
                    activeBadge.innerText = "FLUX (HF)";
                    const hfKey = getKey('hf');
                    if(!hfKey) throw new Error("Missing Hugging Face API Key. Paste key starting with 'hf_' in sidebar.");
                    
                    const res = await fetch("https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-dev", {
                        method: "POST", headers: { "Authorization": `Bearer ${hfKey}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ inputs: text }),
                        signal: signal
                    });
                    if (!res.ok) throw new Error(`Flux Error: ${res.status}`);
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    const div = document.createElement('div'); div.className = "msg-enter flex justify-start w-full";
                    div.innerHTML = `<div class="bg-slate-800 border border-slate-700 p-2 rounded-2xl rounded-tl-none shadow-lg max-w-sm"><img src="${url}" class="rounded-lg w-full"></div>`;
                    document.getElementById('chat-container').appendChild(div);
                    return; // Exit successfully
                }

                // ROUTING
                let selectedModel = document.getElementById('model-select').value;
                let provider = "GEMINI";
                if (selectedModel === 'auto') {
                    if (imgData) { selectedModel = 'gemini-2.0-flash-exp'; provider = "GEMINI (VISION)"; } // Switched to 2.0
                    else if (text.match(/solve|math|calculate|code|python|script|function|logic/i)) { selectedModel = 'groq-deepseek'; provider = "DEEPSEEK R1"; }
                    else { selectedModel = 'gemini-2.0-flash-exp'; provider = "GEMINI"; } // Switched to 2.0
                } else {
                    if (selectedModel.includes('groq')) provider = "GROQ";
                    else if (selectedModel.includes('hf')) provider = "MISTRAL/QWEN";
                }
                activeBadge.innerText = provider;

                // Search
                const webToggle = document.getElementById('web-toggle');
                let webContext = "";
                // SAFELY CHECK CHECKED STATUS
                if (webToggle && webToggle.checked && text && !imgData) {
                    try {
                        const searchRes = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://html.duckduckgo.com/html/?q=' + text)}`, { signal });
                        const json = await searchRes.json();
                        if (json.contents) {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(json.contents, 'text/html');
                            const snippets = Array.from(doc.querySelectorAll('.result__body')).slice(0, 3).map(e => e.innerText.trim()).join('\n');
                            if (snippets) webContext = `[WEB RESULTS]:\n${snippets}\n\n`;
                        }
                    } catch(e) {}
                }

                // Construct Efficient Transcript History
                let promptText = SYS_PROMPT + "\n\n";
                if (!text.match(/remember|previous|context/i)) chatHistory = [];
                chatHistory.push({ role: "user", content: webContext + (text || "Describe this image.") });
                
                chatHistory.forEach(msg => {
                    promptText += `${msg.role === 'user' ? 'User' : 'AI'}: ${msg.content}\n`;
                });

                let reply = "";
                // GEMINI
                if (selectedModel.includes('gemini')) {
                    const key = getKey('gemini');
                    if (!key) throw new Error("Missing Gemini Key (GE.txt or Manual).");
                    const parts = [{ text: promptText }];
                    if (imgData) parts.push({ inline_data: { mime_type: "image/jpeg", data: imgData } });
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${key}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: parts }] }),
                        signal: signal
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    reply = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(!reply) throw new Error("No text response from Gemini.");
                } 
                // GROQ
                else if (selectedModel.includes('groq')) {
                    const key = getKey('groq');
                    if (!key) throw new Error("Missing Groq Key (GR.txt or Manual).");
                    if(imgData) throw new Error("Groq cannot see images. Switch to Gemini.");
                    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: [{role: "system", content: SYS_PROMPT}, ...chatHistory], model: selectedModel === 'groq-deepseek' ? 'deepseek-r1-distill-llama-70b' : 'llama-3.3-70b-versatile', temperature: 0.6 }),
                        signal: signal
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    reply = data.choices?.[0]?.message?.content;
                } 
                // HF
                else if (selectedModel.includes('hf')) {
                    const key = getKey('hf');
                    if (!key) throw new Error("Missing HF Key (HU.txt or Manual).");
                    if(imgData) throw new Error("HF Chat cannot see images.");
                    const modelId = selectedModel === 'hf-qwen' ? "Qwen/Qwen2.5-Coder-32B-Instruct" : "mistralai/Mistral-7B-Instruct-v0.3";
                    const res = await fetch(`https://api-inference.huggingface.co/models/${modelId}/v1/chat/completions`, {
                        method: "POST", headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ messages: [{role: "system", content: SYS_PROMPT}, ...chatHistory], max_tokens: 1000 }),
                        signal: signal
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error);
                    reply = data.choices?.[0]?.message?.content;
                }
                
                clearTimeout(timeoutId);
                chatHistory.push({ role: "assistant", content: reply });
                addMessage('assistant', reply);

            } catch (err) {
                clearTimeout(timeoutId);
                let msg = err.message;
                // Auto-wipe bad user keys
                if (msg.includes("401") || msg.includes("API key not valid")) {
                    if (USER_KEYS.gemini || USER_KEYS.groq || USER_KEYS.hf) {
                        clearUserKeys();
                        msg += " (Bad User Key Auto-Removed. Try again to use System Key)";
                    }
                }
                if (err.name === 'AbortError') msg = "Network Timeout (30s). Try again.";
                addMessage('assistant', `⚠️ **Error:** ${msg}`);
            } finally {
                clearTimeout(timeoutId);
                setLoadState(false);
                btn.disabled = false;
                activeController = null;
            }
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `msg-enter flex ${role==='user'?'justify-end':'justify-start'} w-full`;
            let content = text || "Error: Empty response";
            if (role === 'assistant') {
                content = content.replace(/<think>([\s\S]*?)<\/think>/g, '<div class="mb-2 p-2 bg-indigo-900/30 border-l-2 border-indigo-400 text-indigo-300 text-xs font-mono rounded-r">$1</div>');
                content = marked.parse(content);
            }
            const bg = role === 'user' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-200 border border-slate-700';
            div.innerHTML = `<div class="${bg} max-w-[90%] md:max-w-2xl rounded-2xl ${role==='user'?'rounded-tr-none':'rounded-tl-none'} px-5 py-3 shadow-lg overflow-hidden"><div class="prose prose-invert prose-sm max-w-none leading-relaxed">${content}</div></div>`;
            const box = document.getElementById('chat-container'); box.appendChild(div);
            if(role === 'assistant') {
                const el = div.querySelector('.prose'); Prism.highlightAllUnder(el);
                renderMathInElement(el, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}] });
            }
            box.scrollTop = box.scrollHeight;
        }

        window.onload = () => { lucide.createIcons(); loadKeys(); };
    </script>
</body>
</html>
